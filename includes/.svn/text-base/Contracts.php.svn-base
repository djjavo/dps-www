<?php
class Contracts{
	public static function signed_latest_contract($username){
		return pg_fetch_result(RawDB::query("SELECT COUNT(1) FROM web_members_contracts WHERE contract_id = (SELECT contract_id FROM web_contracts ORDER BY date DESC LIMIT 1) AND username = '".$username."'"),0,0);
	}
	public static function get_latest_contract(){
		return pg_fetch_object(RawDB::query("SELECT *,EXTRACT(EPOCH FROM date) AS date FROM web_contracts ORDER BY web_contracts.date DESC LIMIT 1;"),null,'Contract');
	}
	public static function sign_contract($username,$contract_id,$name){
		if(!is_numeric($contract_id)) throw new UserError;
		if(self::get_latest_contract()->get_contract_id() != $contract_id) throw new UserError("Contract has been updated. Please review.");
		$result = RawDB::query("INSERT INTO web_members_contracts (contract_id,username,name) VALUES ('".$contract_id."','".$username."','".pg_escape_string($name)."')");
		return (bool) pg_affected_rows($result);
	}
	public static function get_signed_contract($username){
		$result = RawDB::query("SELECT *,EXTRACT(EPOCH FROM date) AS date,EXTRACT(EPOCH FROM time) AS time FROM web_members_contracts INNER JOIN web_contracts USING (contract_id) WHERE username = '".$username."'");
		if(pg_num_rows($result)) return pg_fetch_object($result,null,'SignedContract');
		else return false;
	}
}
class Contract{
	protected $contract_id;
	protected $date;
	protected $contract;
	public function get_contract_id(){
		return $this->contract_id;
	}
	public function get_date(){
		return $this->date;
	}
	public function get_contract(){
		return $this->contract;
	}
}
class SignedContract extends Contract{
	protected $username;
	protected $time;
	protected $name;
	public function get_username(){
		return $this->username;
	}
	public function get_time(){
		return $this->time;
	}
	public function get_name(){
		return $this->name;
	}
}
?>