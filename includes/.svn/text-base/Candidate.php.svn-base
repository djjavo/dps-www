<?php
class Candidate{
	protected $candidate_id;
	protected $name;
	protected $votes;
	
	public function set_name($name) {
		$this->name = $name;
		return true;
	}
	public function get_name(){
		return $this->name;
	}
	public function get_candidate_id(){
		return $this->candidate_id;
	}
	public function get_votes(){
		return $this->votes;
	}
	
	public function vote($email) {
		
		if(!Poll::is_valid_email($email))		throw new UserError("Type an email");
		
		if(Poll::has_previous_voted($email))	throw new UserError("You have already voted");

		$verification_code = md5($email . "seed123ap19xab" . time());
		
		$query = "INSERT INTO web_polling_votes (email,candidate_id,verification_code) VALUES ('".pg_escape_string($email)."',".$this->get_candidate_id().",'".$verification_code."');";

		if(!RawDB::query($query))				throw new UserError("Error submitting your vote");;
		
		$body	= "Hi! You recently voted in a RaW 1251AM poll.\n"
				. "To verify your vote, please click the following link:\n"
				. SITE_LINK_ABS . "vote/verify?email=".$email."&code=" . $verification_code;
		
		$headers = "From: Radio Warwick<website@radio.warwick.ac.uk>";
		$headers .= "\r\nReply-To: Radio Warwick<website@radio.warwick.ac.uk>";
		
		if(!mail($email,"Vote verification",$body,$headers,'-fwww-bounces@radio.warwick.ac.uk'))
			throw new UserError("An error occured when counting your vote. Please contact webmaster.");
				
	}
}
?>
