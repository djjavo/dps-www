<?php
class Group{
	private $group;
	private $groupid;
	private $admin;
	public function __construct(){
		$this->admin = ($this->admin == 't');	
	}
	public function get_groupid(){
		return $this->groupid;	
	}
	public function get_group(){
		return $this->group;
	}
	public function get_name(){
		return $this->group;
	}
	public function get_name_pretty(){
		$return = $this->group;
		if(substr($return,0,6) == "tools_" )
			$return = substr($return,6);
		$return = str_replace("_"," ",$return);
		$return = ucwords($return);
		return $return;
	}
	public function is_user($user = null){
		if(is_null($user))
			$user = Session::get_member();
		$result = RawDB::query("SELECT * FROM web_members_groups WHERE groupid ='".$this->groupid."' AND username = '".$user->get_username()."'");
		if(pg_num_rows($result) > 0)
			return true;
		return false;
	}
	public function is_user_admin($user = null){
		if(is_null($user))
			$user = Session::get_member();
		$result = RawDB::query("SELECT * FROM web_members_groups WHERE groupid ='".$this->groupid."' AND username = '".$user->get_username()."' AND admin = true");
		if(pg_num_rows($result) > 0)
			return true;
		return false;
	}
	public function is_admin(){
		return $this->admin;
	}
	public function get_members($admin = true){
		$result = RawDB::query("SELECT web_members.* FROM web_members_groups INNER JOIN web_members USING (username) WHERE groupid = '".$this->groupid."'".($admin?"":"AND admin = false"));
		$array = array();
		while($object = pg_fetch_object($result, NULL, 'Member'))
			$array[] = $object;
		return $array;
	}
	public function get_admins(){
		$result = RawDB::query("SELECT web_members.* FROM web_members_groups INNER JOIN web_members USING (username) WHERE groupid = '".$this->groupid."' AND web_members_groups.admin = true");
		$return = array();
		while($object = pg_fetch_object($result,null,"Member"))
			$return[] = $object;
		return $return;
	}
	public function add_member($member_object,$admin = false){
		if(!($this->admin || Session::is_group_member("group_admin")))	throw new UserError("You are not an administrator of this group");
		RawDB::query("INSERT INTO web_members_groups (username,groupid,admin) VALUES
		('".$member_object->get_username()."','".$this->get_groupid()."','".($admin?'true':'false')."')");
	}
	public function remove_member($member_object){
		if(!($this->admin || Session::is_group_member("group_admin")))	throw new UserError("You are not an administrator of this group");
		if($member_object == Session::get_profile())	throw new UserError("You cannot remove yourself from a group");
		return RawDB::query("DELETE FROM web_members_groups WHERE
		username = '".$member_object->get_username()."' AND groupid = '".$this->get_groupid()."'");
	}
	public function edit_admin($member_object,$admin = false){
		if(!($this->admin || Session::is_group_member("group_admin")))	throw new UserError("You are not an administrator of this group");
		if($member_object == Session::get_profile())	throw new UserError("You cannot change your status in a group");
		RawDB::query("UPDATE web_members_groups SET admin = '".($admin?'true':'false')."' WHERE username = '".$member_object->get_username()."' AND groupid = '".$this->groupid."'");
	}
	public function save(){
		if(is_null($this->groupid))
			RawDB::query("INSERT INTO web_groups (group) VALUES ('".$this->get_group()."')");
	}
	public function delete(){
			RawDB::query("DELETE FROM web_groups WHERE groupid = '".$this->get_groupid()."'");
	}
}
?>
