<?php
class Members{
	public static function search_name($string){
		if(strlen($string)<=2)	throw new UserError("Search query too short");
				
		foreach(explode(" ",$string) AS $part)
			$array[] = "name ILIKE '%".pg_escape_string($part)."%'";
			
		$part = implode(" AND ",$array);
		
		$results = pg_fetch_result(RaWDB::query("SELECT COUNT(1) FROM web_members WHERE ".$part),0,0);
		if(!$results)	throw new UserError("No results");
		if($results>20)	throw new UserError("Too many results returned");
			
		$result = RaWDB::query("SELECT * FROM web_members WHERE ".$part);
		$array = array();
		if(pg_num_rows($result)){
			while($object = pg_fetch_object($result,null,"Member"))
				$array[] = $object;
		}
		return $array;
	}
	public static function search_id($id){
		if(!preg_match("/[0-9]{7}/",$id)){
			throw new UserError("Invalid Student ID");
			return false;
		}
		$result = RaWDB::query("SELECT * FROM web_members WHERE id = '".$id."'");
		if(pg_num_rows($result))
			return pg_fetch_object($result,null,"Member");
		else
			return false;
	}
	public static function search_username($username){
                if(!preg_match("/[a-z0-9]+/",$username)){
                        throw new UserError("Invalid RaW Username");
                        return false;
                }
		$result = RaWDB::query("SELECT * FROM web_members WHERE username = '".pg_escape_string($username)."' LIMIT 1;");
		if(pg_num_rows($result))
			return pg_fetch_object($result,null,"Member");
		else
			return false;
	}
	public static function check_exists($username){
                if(!preg_match("/[a-z0-9]+/",$username)){
                        throw new UserError("Invalid RaW Username");
                        return false;
                }
		return pg_fetch_result(RaWDB::query("SELECT COUNT(1) FROM web_members WHERE username = '".pg_escape_string($username)."' LIMIT 1;"),0,0);
	}
	public static function get($username){
		return self::search_username($username);
	}
	public static function getExec($department){
		if (is_numeric($department)){
        	$result = RawDB::query("SELECT * FROM web_members_exec INNER JOIN web_members ON web_members_exec.username = web_members.username WHERE department_id = ".$department);
        }else if(is_string($department)){
        	if(preg_match("/[\r\n]/",$department))
            	return false;
            $department = Departments::getIDFromName($department);
			$result = RawDB::query("SELECT * FROM web_members_exec INNER JOIN web_members ON web_members_exec.username = web_members.username WHERE department_id = ".$department);
        }
		return pg_fetch_object($result, NULL, 'ExecMember'); 
	}
	public static function get_departments($username){
		$result = RawDB::query("SELECT * FROM web_members_departments WHERE username='".$username."'");
		return pg_fetch_object($result, NULL, 'Department');
	}

}	
?>
